<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dentist – New Allergy Test Order</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7f9;
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 30px;
      border-bottom: 1px solid #ddd;
      background: #ffffff;
    }
    .logo { font-weight: bold; }
    .top-info span { margin-left: 20px; }
    .btn-outline {
      border: 1px solid #000;
      padding: 6px 14px;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
    }
    h1 {
      text-align: center;
      margin-top: 30px;
    }
    .container {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 20px 40px;
    }
    .card-row {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 0 1px #e2e2e2;
      padding: 20px;
      flex: 1 1 320px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .checkbox-list label {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .checkbox-list input {
      width: auto;
      margin-right: 6px;
    }
    .actions {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    .btn {
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
    }
    .btn-cancel {
      background: #ffffff;
      border: 1px solid #000;
    }
    .btn-primary {
      background: #21b44f;
      color: #fff;
    }
    .hidden { display: none; }

    .success-icon {
      font-size: 32px;
      margin-right: 10px;
    }
    .qr-wrapper {
      text-align: center;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .qr-wrapper img {
      width: 180px;
      height: 180px;
    }
    .secondary-actions {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
    }
    .btn-secondary {
      border: 1px solid #000;
      padding: 10px 18px;
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
{% include 'header.html' %}

<h1>New Allergy Test Order</h1>

<div class="container">

  <div id="createScreen">
    <div class="card-row">
      <div class="card">
        <h3>Patient Data</h3>
        <label>IIN *</label>
        <input id="iin" type="text" placeholder="123456789012">

        <label>Patient Full Name *</label>
        <input id="fullName" type="text" placeholder="Surname Name Patronymic">

        <label>Phone (WhatsApp) *</label>
        <input id="phone" type="text" placeholder="+7 701 123 45 67">

        <label>Date of Birth</label>
        <input id="dob" type="date">
      </div>

      <div class="card">
        <h3>Prescription</h3>

        <label>Select Tariff / Package *</label>
        <select id="tariff">
          <option value="">Select Tariff / Package</option>
          <option value="Basic">Basic</option>
          <option value="Extended">Extended</option>
          <option value="VIP">VIP</option>
        </select>

        <p><strong>Allergens List</strong></p>
        <div class="checkbox-list">
          <label><input type="checkbox" name="allergen" value="Lidocaine"> Lidocaine</label>
          <label><input type="checkbox" name="allergen" value="Articaine"> Articaine</label>
          <label><input type="checkbox" name="allergen" value="Mepivacaine"> Mepivacaine</label>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-cancel" type="button" onclick="resetForm()">CANCEL</button>
      <button class="btn btn-primary" type="button" onclick="createOrder()">
        CREATE ORDER &amp; SEND TO TELEGRAM
      </button>
    </div>
    <p id="errorMsg" style="text-align:center;color:#d11;margin-top:10px;"></p>
  </div>


  <div id="successScreen" class="hidden">
    <div style="text-align:center;margin-bottom:20px;">
      <span class="success-icon">✅</span>
      <span style="font-size:22px;">
        Order <strong id="orderIdTitle"></strong> Successfully Created!
      </span>
    </div>

    <p style="text-align:center;">
      <strong>Patient:</strong> <span id="patientNameLabel"></span><br>
      <strong>Status:</strong> Sent to WhatsApp to number
      <span id="patientPhoneLabel"></span>
    </p>

    <div class="qr-wrapper">
      <p><strong>SHOW SCREEN TO PATIENT</strong></p>
      <img id="qrImage" alt="QR Code">
      <p>Order Code: <strong id="orderCodeLabel"></strong></p>
    </div>

    <p style="text-align:center;font-size:13px;">
      Tell the patient: "Show this QR code at the laboratory".<br>
      Laboratory addresses have already been sent to their Telegram.
    </p>

    <div class="secondary-actions">
      <button class="btn-secondary" type="button" onclick="alert('TODO: print coupon')">
        Print Coupon
      </button>
      <button class="btn-secondary" type="button" onclick="alert('TODO: resend Telegram')">
        Resend Telegram
      </button>
    </div>

    <div class="actions">
      <button class="btn btn-primary" type="button" onclick="window.location.href='/lab'">
        GO TO ORDER LIST (LAB)
      </button>
      <button class="btn btn-cancel" type="button" onclick="backToNew()">
        CREATE NEW ORDER
      </button>
    </div>
  </div>
</div>

<script>
  const API_BASE = "";

  function resetForm() {
    document.getElementById('iin').value = "";
    document.getElementById('fullName').value = "";
    document.getElementById('phone').value = "";
    document.getElementById('dob').value = "";
    document.getElementById('tariff').value = "";
    document.querySelectorAll('input[name="allergen"]').forEach(cb => cb.checked = false);
    document.getElementById('errorMsg').textContent = "";
  }

  function collectAllergens() {
    const arr = [];
    document.querySelectorAll('input[name="allergen"]:checked').forEach(cb => {
      arr.push(cb.value);
    });
    return arr;
  }

  async function createOrder() {
    const clinicName = document.getElementById('clinicLabel').textContent;
    const doctorName = document.getElementById('doctorLabel').textContent;

    const iin = document.getElementById('iin').value.trim();
    const fullName = document.getElementById('fullName').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const dob = document.getElementById('dob').value || null;
    const tariff = document.getElementById('tariff').value;
    const allergens = collectAllergens();

    if (!iin || !fullName || !phone || !tariff || allergens.length === 0) {
      document.getElementById('errorMsg').textContent = "Заполните все обязательные поля и выберите хотя бы один аллерген";
      return;
    }

    const payload = {
      clinic_name: clinicName,
      doctor_name: doctorName,
      tariff: tariff,
      allergens: allergens,
      patient: {
        iin: iin,
        full_name: fullName,
        phone_whatsapp: phone,
        date_of_birth: dob || "1990-01-01"
      }
    };

    try {
      const resp = await fetch(`${API_BASE}/orders`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const data = await resp.json();
        throw new Error(data.detail || "Error creating order");
      }

      const order = await resp.json();
      showSuccess(order);
    } catch (e) {
      document.getElementById('errorMsg').textContent = e.message;
    }
  }

  function showSuccess(order) {
    document.getElementById('createScreen').classList.add('hidden');
    document.getElementById('successScreen').classList.remove('hidden');

    document.getElementById('orderIdTitle').textContent = `#ORD-${order.code}`;
    document.getElementById('patientNameLabel').textContent = order.patient.full_name;
    document.getElementById('patientPhoneLabel').textContent = order.patient.phone_whatsapp;
    document.getElementById('qrImage').src = order.qr_data_url;
    document.getElementById('orderCodeLabel').textContent = order.code;
  }

  function backToNew() {
    resetForm();
    document.getElementById('successScreen').classList.add('hidden');
    document.getElementById('createScreen').classList.remove('hidden');
  }
</script>
</body>
</html>
