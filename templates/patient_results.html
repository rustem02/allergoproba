<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Allergy Test Results</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f7f9; margin:0; }
    .container {
      max-width:480px; margin:10px auto; background:#fff;
      padding:16px; box-shadow:0 0 0 1px #ddd; border-radius:8px;
    }
    h2 { text-align:center; margin-top:5px; }
    table {
      width:100%; border-collapse:collapse; margin-top:10px;
      font-size:14px;
    }
    th, td {
      border:1px solid #ddd; padding:6px 8px; text-align:left;
    }
    th { background:#f0f0f0; }
    button {
      padding:8px 16px; border-radius:4px; border:1px solid #000;
      background:#fff; cursor:pointer; margin-top:10px;
    }
    small { color:#555; }
  </style>
</head>
<body>
<div class="container">
  <h2>Allergy Test Results</h2>
  <p id="patientLine"></p>
  <p id="statusLine"></p>

  <div id="resultsBlock"></div>

  <button onclick="alert('Здесь будет скачивание PDF')">
    Download PDF
  </button>
</div>

<script>
  const API_BASE = "";

  function getCode() {
    const params = new URLSearchParams(window.location.search);
    return params.get("code");
  }

  async function loadResults() {
    const code = getCode();
    if (!code) {
      alert("Missing code in URL");
      return;
    }
    const resp = await fetch(`${API_BASE}/patient/${code}/results`);
    if (!resp.ok) {
      alert("Order not found");
      return;
    }
    const order = await resp.json();

    document.getElementById("patientLine").textContent =
      `${order.patient.full_name} (Order #ORD-${order.code})`;
    document.getElementById("statusLine").innerHTML =
      `<small>Status: ${order.status}</small>`;

    const container = document.getElementById("resultsBlock");

    if (!order.results) {
      container.innerHTML =
        "<p>Results are not ready yet. Please try again later.</p>";
      return;
    }

    let html = "<table><tr><th>Allergen</th><th>Result</th></tr>";
    for (const [allergen, result] of Object.entries(order.results)) {
      html += `<tr><td>${allergen}</td><td>${result}</td></tr>`;
    }
    html += "</table>";
    container.innerHTML = html;
  }

  loadResults();
</script>
</body>
</html>
